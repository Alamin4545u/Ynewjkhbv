<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSKF - কুপ্তলা আলোকিত সমাজ ফাউন্ডেশন</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background: #f8fafc; color: #1e293b; scroll-behavior: smooth; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .section-hide { display: none; }
        .premium-card { background: white; border-radius: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .btn-green { background: linear-gradient(135deg, #10b981, #059669); color: white; transition: all 0.3s; }
        .btn-green:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3); }

        /* --- Official Member Form / Certificate Style --- */
        #certificateTemplate {
            width: 850px; height: 1150px; background: white; position: fixed; left: -9999px;
            padding: 70px; color: #000; overflow: hidden; border: 1px solid #ddd;
        }
        .cert-header { text-align: center; position: relative; margin-bottom: 40px; }
        .cert-logo { position: absolute; left: 0; top: 0; width: 110px; }
        .photo-box { position: absolute; right: 0; top: 0; width: 100px; height: 120px; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .bismillah { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .org-name { font-size: 32px; font-weight: 900; }
        .est-date { font-size: 16px; font-weight: bold; margin-top: 5px; }

        .rules-header { background: #000; color: #fff; padding: 5px 15px; display: inline-block; font-weight: bold; margin: 25px 0 10px 0; font-size: 15px; }
        .rules-content { font-size: 16px; line-height: 1.8; text-align: justify; }
        .highlight-box { border: 2px solid #000; padding: 15px; margin: 15px 0; font-weight: 600; line-height: 1.6; }

        .form-body { margin-top: 40px; font-size: 18px; line-height: 2.8; }
        .dotted-line { border-bottom: 1.5px dotted #000; display: inline-block; padding: 0 10px; font-weight: bold; color: #1e40af; min-width: 60px; text-align: center; }
        
        .signature-area { margin-top: 100px; display: flex; justify-content: space-between; text-align: center; }
        .sig-col { width: 180px; border-top: 1px solid #000; padding-top: 10px; font-size: 14px; font-weight: bold; position: relative; }
        .admin-sig { font-family: 'Dancing Script', cursive; position: absolute; top: -40px; left: 0; right: 0; font-size: 30px; color: #1e40af; }
        
        /* Ticker Animation */
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { animation: marquee 30s linear infinite; }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="glass-nav px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer" onclick="showSection('home')">
            <div class="bg-green-600 p-2 rounded-xl shadow-lg"><i data-lucide="shield-check" class="text-white w-5 h-5"></i></div>
            <span class="text-xl font-black italic tracking-tighter">BSKF.</span>
        </div>
        <div class="relative">
            <button id="profileBtn" class="bg-white border-2 border-slate-100 p-2 rounded-xl shadow-sm hover:border-green-500 transition">
                <i data-lucide="user" class="w-6 h-6 text-slate-600"></i>
            </button>
            <div id="profileMenu" class="hidden absolute right-0 mt-3 w-56 bg-white rounded-2xl shadow-2xl border p-2 z-50">
                <div id="guestLinks" class="space-y-1">
                    <button onclick="showSection('login')" class="w-full text-left px-5 py-3 hover:bg-slate-50 rounded-xl font-bold text-sm">লগইন</button>
                    <button onclick="showSection('register')" class="w-full text-left px-5 py-3 hover:bg-green-50 rounded-xl font-bold text-sm text-green-600">নতুন নিবন্ধন</button>
                </div>
                <div id="userLinks" class="hidden space-y-1">
                    <button onclick="showSection('dashboard')" class="w-full text-left px-5 py-3 hover:bg-slate-50 rounded-xl font-bold text-sm">ড্যাশবোর্ড</button>
                    <button onclick="logout()" class="w-full text-left px-5 py-3 hover:bg-red-50 text-red-600 rounded-xl font-bold text-sm border-t mt-1 pt-3">লগআউট</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Wrapper -->
    <main class="max-w-4xl mx-auto p-4 md:p-6 space-y-10">
        
        <!-- Home Section -->
        <section id="home">
            <header class="text-center py-12">
                <h1 class="text-5xl md:text-7xl font-black tracking-tighter italic uppercase text-slate-800">BSKF <span class="text-green-600">Foundation</span></h1>
                <p class="text-slate-500 italic font-bold mt-2">কুপ্তলা আলোকিত সমাজ ফাউন্ডেশন</p>
            </header>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="premium-card p-8 border-t-8 border-green-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">মোট ফান্ড</p>
                    <h3 id="statFund" class="text-3xl font-black">৳ ০</h3>
                </div>
                <div class="premium-card p-8 border-t-8 border-red-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">মোট ব্যয়</p>
                    <h3 id="statExpense" class="text-3xl font-black">৳ ০</h3>
                </div>
                <div class="premium-card p-8 border-t-8 border-blue-500 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">সদস্যবৃন্দ</p>
                    <h3 id="statMembers" class="text-3xl font-black">০ জন</h3>
                </div>
            </div>

            <!-- News Ticker -->
            <div class="bg-slate-900 py-4 rounded-3xl overflow-hidden shadow-xl mb-12">
                <div id="ticker" class="flex gap-20 animate-marquee whitespace-nowrap text-white text-[11px] font-bold italic uppercase tracking-widest">
                    <!-- Members List will load here -->
                </div>
            </div>

            <!-- Expense List -->
            <div class="premium-card p-8 overflow-hidden">
                <h4 class="text-lg font-black mb-6 flex items-center gap-2 italic uppercase"><i data-lucide="receipt"></i> সাম্প্রতিক ব্যয়ের বিবরণ</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-[10px] uppercase font-black text-slate-400">
                            <tr><th class="py-3 px-4">বিবরণ</th><th class="py-3 px-4">পরিমাণ</th><th class="py-3 px-4 text-right">তারিখ</th></tr>
                        </thead>
                        <tbody id="homeExpList" class="font-bold divide-y divide-slate-50">
                            <!-- JS Data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="register" class="section-hide max-w-xl mx-auto">
            <div class="premium-card p-10 border-t-8 border-green-600">
                <h2 class="text-2xl font-black mb-2 text-center italic">সদস্য নিবন্ধন ফর্ম</h2>
                <p class="text-center text-red-500 text-xs font-black mb-8 italic">নিবন্ধন ফি ২০০ টাকা প্রদান করে ফরমটি পূরণ করুন।</p>
                <form id="regForm" class="space-y-4">
                    <input type="text" id="regName" placeholder="আপনার পুরো নাম" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    <input type="text" id="regPhone" placeholder="মোবাইল নম্বর" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    <input type="text" id="regNID" placeholder="এনআইডি নম্বর" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    <input type="password" id="regPass" placeholder="পাসওয়ার্ড তৈরি করুন" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold" required>
                    
                    <div class="bg-green-50 p-6 rounded-[2rem] border-2 border-dashed border-green-200 space-y-4">
                        <h4 class="text-center font-black text-green-700 text-sm italic">নিচের নম্বরে ফি পাঠিয়ে TrxID দিন</h4>
                        <div id="regPayNumbers" class="flex flex-wrap justify-center gap-4 text-[10px] font-black text-slate-600 uppercase italic">
                            <!-- Bkash/Nagad Numbers -->
                        </div>
                        <input type="text" id="regTrx" placeholder="Transaction ID (TrxID)" class="w-full p-4 bg-white rounded-xl border-2 border-green-300 font-black text-center uppercase tracking-widest" required>
                    </div>
                    <button type="submit" class="w-full btn-green py-5 rounded-2xl font-black text-lg shadow-xl uppercase italic">Apply For Membership</button>
                </form>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login" class="section-hide max-w-sm mx-auto">
            <div class="premium-card p-10 border-t-8 border-slate-900 text-center">
                <h2 class="text-2xl font-black mb-8 italic uppercase">Member Login</h2>
                <form id="loginForm" class="space-y-4">
                    <input type="text" id="logPhone" placeholder="মোবাইল নম্বর" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                    <input type="password" id="logPass" placeholder="পাসওয়ার্ড" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                    <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black italic">LOGIN →</button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section-hide space-y-8">
            <div id="activeDashboard" class="hidden space-y-8">
                <div class="premium-card p-12 text-center relative overflow-hidden border-t-8 border-green-500">
                    <div class="bg-green-500 text-white absolute top-8 right-8 px-4 py-1 rounded-full text-[10px] font-black italic shadow-lg">VERIFIED MEMBER</div>
                    <h4 id="dashName" class="text-4xl font-black text-slate-900 mb-1 tracking-tight italic uppercase">...</h4>
                    <p id="dashID" class="text-[12px] text-slate-400 font-black tracking-[0.4em] uppercase mb-10">ID: BSKF-0000</p>
                    <div class="grid grid-cols-2 gap-4 text-left border-t pt-8 text-xs font-bold text-slate-500 italic">
                        <p>NID: <span id="dashNID" class="text-slate-900">...</span></p>
                        <p>Phone: <span id="dashPhone" class="text-slate-900">...</span></p>
                    </div>
                    <button onclick="downloadCertificate()" class="mt-10 bg-slate-900 text-white px-8 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest flex items-center gap-2 mx-auto shadow-2xl hover:scale-105 transition active:scale-95">
                        <i data-lucide="download" class="w-4 h-4"></i> ডাউনলোড সদস্যপত্র (ফরম)
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showSection('payment')" class="bg-green-600 text-white p-8 rounded-[2.5rem] flex flex-col items-center gap-3 shadow-xl font-black italic">
                        <i data-lucide="plus-circle" class="w-8 h-8"></i> চাঁদা জমা দিন
                    </button>
                    <button onclick="showSection('history')" class="bg-white border p-8 rounded-[2.5rem] flex flex-col items-center gap-3 shadow-sm font-black italic">
                        <i data-lucide="history" class="w-8 h-8 text-blue-500"></i> পেমেন্ট ইতিহাস
                    </button>
                </div>
            </div>

            <div id="pendingStatus" class="hidden bg-yellow-50 border-2 border-dashed border-yellow-200 p-12 rounded-[3rem] text-center">
                <i data-lucide="clock" class="w-16 h-16 text-yellow-500 mx-auto mb-6"></i>
                <h3 class="text-2xl font-black text-yellow-700 italic">আপনার আবেদনটি অপেক্ষমান!</h3>
                <p class="text-sm font-bold text-slate-500 mt-2 italic max-w-xs mx-auto">এডমিন আপনার নিবন্ধন ফি যাচাই করার পর আইডি সক্রিয় করা হবে। ধন্যবাদ।</p>
            </div>
        </section>

        <!-- Payment Section -->
        <section id="payment" class="section-hide max-w-md mx-auto">
            <div class="premium-card p-10 border-t-8 border-green-600">
                <h3 class="text-xl font-black mb-8 italic uppercase tracking-tighter">মাসিক চাঁদা প্রদান</h3>
                <form id="payForm" class="space-y-4">
                    <select id="pMethod" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                        <option value="">মেথড সিলেক্ট করুন</option><option value="Bkash">Bkash</option><option value="Nagad">Nagad</option>
                    </select>
                    <input type="number" id="pAmt" placeholder="টাকার পরিমাণ" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold" required>
                    <input type="text" id="pTrx" placeholder="Transaction ID (TrxID)" class="w-full p-4 bg-slate-50 rounded-2xl border font-black uppercase tracking-widest" required>
                    <button type="submit" class="w-full btn-green py-4 rounded-2xl font-black italic tracking-widest shadow-lg">CONFIRM PAYMENT</button>
                </form>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="section-hide max-w-md mx-auto space-y-4 pb-20">
            <h3 class="text-xl font-black italic mb-6">আপনার পেমেন্ট রেকর্ড</h3>
            <div id="histList" class="space-y-3">
                <!-- List items -->
            </div>
        </section>

        <!-- --- HIDDEN OFFICIAL FORM TEMPLATE (Hoo-bo-hoo Design) --- -->
        <div id="certificateTemplate">
            <!-- Background Watermark Logo -->
            <img src="https://i.ibb.co/Lhq99F5/bskf-logo.png" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 450px; opacity: 0.08;">

            <div class="cert-header">
                <img src="https://i.ibb.co/Lhq99F5/bskf-logo.png" class="cert-logo">
                <div class="bismillah">বিসমিল্লাহির রাহমানির রাহিম</div>
                <div class="org-name">(কুপ্তলা আলোকিত সমাজ ফাউন্ডেশন)</div>
                <div class="est-date">স্থাপিত-২০২৩ইং</div>
                <div class="photo-box">ছবি</div>
            </div>

            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">
                সদস্য নং- <span id="certID" class="dotted-line" style="min-width: 150px;">BSKF-0000</span>
            </div>

            <div class="rules-header">সংগঠনের নীতিমালা এবং সদস্যপদ গ্রহণের ফর্ম :</div>

            <div class="rules-content">
                <p>১। এটি একটি সেবামূলক সংগঠন। সংগঠনের অর্থ শুধুমাত্র গরিব ও অসহায়দের সাহায্য সহযোগিতার জন্য ব্যয় হবে।</p>
                <p>২। সংগঠনের সকল কার্যক্রম সদস্যদের নিজস্ব অর্থে পরিচালিত হবে।</p>
                
                <!-- Red Box Content (Highlighted Point 4 & 5) -->
                <div class="highlight-box">
                    <p>৪। এই সংগঠনের কোনো সদস্যগণ সংগঠনের ভিতর কোন ধরনের রাজনৈতিক প্রভাব দেখাতে পারবে না। যদি কোনো সদস্যের ব্যক্তিগত রাজনৈতিক কারণে সংগঠনের উপর কোনো প্রভাব পড়ে, তবে তার সদস্যপদ বাতিল করা হবে।</p>
                    <p>৫। এই সংগঠনের কোন সদস্য কোন প্রকার একক সিদ্ধান্ত নিতে পারবে না। কোন সিদ্ধান্ত নেওয়ার থাকলে সকল সদস্যগণের সাথে আলোচনা করে সিদ্ধান্ত নিতে হবে। কোন সদস্য ভুল কিছু উপস্থাপন করলে অন্যরা ভদ্রতার সাথে কথা বলে তাকে বোঝাবেন।</p>
                </div>

                <p>৬। সংগঠনের সকল তথ্য এবং হিসাব স্বচ্ছতার সাথে সদস্যদের জানানো হবে এবং প্রয়োজনে স্বাধীনভাবে প্রকাশ করতে পারবে।</p>
                <p>৭। সদস্য ভর্তির ক্ষেত্রে সংগঠনের সকল নিয়ম কানুন মানতে হবে। একইভাবে টানা তিন মাসের টাকা পরিশোধ না করলে সদস্যপদ বাতিল বলে গণ্য হবে।</p>
            </div>

            <div class="form-body">
                আমি <span id="certName" class="dotted-line" style="min-width: 320px;">সদস্যের নাম</span> 
                পিতা/স্বামী <span class="dotted-line" style="min-width: 250px;">..........................................</span> 
                মাতা <span class="dotted-line" style="min-width: 200px;">..........................................</span> <br>
                গ্রাম <span class="dotted-line" style="min-width: 200px;">..........................</span> 
                ইউপি <span class="dotted-line" style="min-width: 200px;">..........................</span> 
                থানা <span class="dotted-line" style="min-width: 150px;">..........................</span> 
                জেলা <span class="dotted-line" style="min-width: 150px;">..........................</span> <br>
                মোবাইল নং- <span id="certPhone" class="dotted-line" style="min-width: 250px;">017XXXXXXXXX</span> 
                এই মর্মে অঙ্গীকার করতেছি যে উক্ত সংগঠনের সকল নিয়ম কানুন মেনে চলবো এবং সংগঠনের শৃঙ্খলা বিরোধী কোন প্রকার কাজ করবো না।
            </div>

            <div style="text-align: right; margin-top: 60px;">
                <p style="font-weight: bold; margin-bottom: 50px; margin-right: 30px;">সদস্যের স্বাক্ষর ও তারিখ</p>
            </div>

            <div class="signature-area">
                <div class="sig-col">
                    <span class="admin-sig">Alfaz</span>
                    সাধারণ সম্পাদক
                </div>
                <div class="sig-col">ক্যাশিয়ার</div>
                <div class="sig-col">সভাপতি</div>
            </div>
        </div>

    </main>

    <script>
        // Firebase Configuration (Replace with your actual keys)
        const firebaseConfig = {
          apiKey: "AIzaSyDeFrZUu2ZwWzFa7owaC0v6WO_zP2lEJ1Q",
          authDomain: "firstdevloping.firebaseapp.com",
          projectId: "firstdevloping",
          storageBucket: "firstdevloping.firebasestorage.app",
          messagingSenderId: "197486624624",
          appId: "1:197486624624:web:2b7b055dc3ecbad20399b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        lucide.createIcons();

        let activeUser = null;

        // Navigation Function
        function showSection(id) {
            ['home', 'register', 'login', 'dashboard', 'payment', 'history'].forEach(s => {
                document.getElementById(s).classList.add('section-hide');
            });
            document.getElementById(id).classList.remove('section-hide');
            document.getElementById('profileMenu').classList.add('hidden');
            window.scrollTo(0,0);
        }

        document.getElementById('profileBtn').onclick = (e) => { 
            e.stopPropagation(); 
            document.getElementById('profileMenu').classList.toggle('hidden'); 
        }
        document.body.onclick = () => document.getElementById('profileMenu').classList.add('hidden');

        // Auth Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const phone = user.email.split('@')[0];
                db.collection("members").doc(phone).onSnapshot(doc => {
                    if(doc.exists) {
                        activeUser = doc.data();
                        updateDashboardUI();
                    }
                });
            } else {
                document.getElementById('guestLinks').classList.remove('hidden');
                document.getElementById('userLinks').classList.add('hidden');
                showSection('home');
            }
        });

        function updateDashboardUI() {
            document.getElementById('dashName').innerText = activeUser.name;
            document.getElementById('dashID').innerText = 'ID: BSKF-' + activeUser.id;
            document.getElementById('dashNID').innerText = activeUser.nid;
            document.getElementById('dashPhone').innerText = activeUser.phone;
            
            // Sync Template Data
            document.getElementById('certName').innerText = activeUser.name;
            document.getElementById('certID').innerText = 'BSKF-' + activeUser.id;
            document.getElementById('certPhone').innerText = activeUser.phone;

            document.getElementById('guestLinks').classList.add('hidden');
            document.getElementById('userLinks').classList.remove('hidden');

            if(activeUser.status === 'pending') {
                document.getElementById('pendingStatus').classList.remove('hidden');
                document.getElementById('activeDashboard').classList.add('hidden');
            } else {
                document.getElementById('pendingStatus').classList.add('hidden');
                document.getElementById('activeDashboard').classList.remove('hidden');
                loadHistory(activeUser.phone);
            }
        }

        // Action: Download Form
        function downloadCertificate() {
            const template = document.getElementById('certificateTemplate');
            html2canvas(template, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `BSKF_Member_Form_${activeUser.name}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        // Load Global Data
        function initApp() {
            // Stats
            db.collection("stats").doc("summary").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('statFund').innerText = '৳ ' + (d.fund || 0).toLocaleString('bn-BD');
                    document.getElementById('statExpense').innerText = '৳ ' + (d.expenses || 0).toLocaleString('bn-BD');
                }
            });

            // Member Ticker
            db.collection("members").where("status", "==", "active").onSnapshot(snap => {
                document.getElementById('statMembers').innerText = snap.size + ' জন';
                const ticker = document.getElementById('ticker'); ticker.innerHTML = "";
                snap.forEach(m => {
                    ticker.innerHTML += `<span>★ ${m.data().name} (${m.data().role || 'সদস্য'})</span>`;
                });
            });

            // Expense List
            db.collection("expenses").onSnapshot(snap => {
                const list = document.getElementById('homeExpList'); list.innerHTML = "";
                let docs = []; snap.forEach(doc => docs.push(doc.data()));
                docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10).forEach(e => {
                    list.innerHTML += `<tr class="border-b border-slate-50"><td class="py-4 px-4">${e.desc}</td><td class="py-4 px-4 text-red-500 font-black">৳ ${e.amount}</td><td class="py-4 px-4 text-right opacity-30 text-[9px] uppercase">${e.timestamp ? new Date(e.timestamp.toDate()).toLocaleDateString('bn-BD') : ''}</td></tr>`;
                });
            });

            // Payment Numbers Config
            db.collection("config").doc("payment_numbers").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('regPayNumbers').innerText = `Bkash: ${d.bkash} | Nagad: ${d.nagad}`;
                }
            });
        }

        // Submissions
        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const phone = document.getElementById('regPhone').value;
            const trx = document.getElementById('regTrx').value;
            try {
                await auth.createUserWithEmailAndPassword(phone + "@bskf.com", document.getElementById('regPass').value);
                const info = { name: document.getElementById('regName').value, phone, nid: document.getElementById('regNID').value, id: Math.floor(1000 + Math.random() * 9000), status: 'pending', role: 'সদস্য' };
                await db.collection("members").doc(phone).set(info);
                await db.collection("payments").add({ phone, amount: 200, trxId: trx, status: 'pending', type: 'registration', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                alert("নিবন্ধন আবেদন সফল হয়েছে!"); showSection('dashboard');
            } catch (err) { alert(err.message); }
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try { 
                await auth.signInWithEmailAndPassword(document.getElementById('logPhone').value + "@bskf.com", document.getElementById('logPass').value); 
                showSection('dashboard'); 
            } catch (err) { alert("মোবাইল নম্বর বা পাসওয়ার্ড ভুল।"); }
        };

        document.getElementById('payForm').onsubmit = async (e) => {
            e.preventDefault();
            await db.collection("payments").add({ 
                phone: activeUser.phone, 
                amount: parseFloat(document.getElementById('pAmt').value), 
                trxId: document.getElementById('pTrx').value, 
                method: document.getElementById('pMethod').value,
                status: 'pending', 
                type: 'monthly', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });
            alert("পেমেন্ট তথ্য জমা হয়েছে!"); showSection('history');
            e.target.reset();
        };

        function loadHistory(phone) {
            db.collection("payments").where("phone", "==", phone).onSnapshot(snap => {
                const list = document.getElementById('histList'); list.innerHTML = "";
                let pd = []; snap.forEach(d => pd.push(d.data()));
                pd.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).forEach(p => {
                    const isOk = p.status === 'confirmed';
                    list.innerHTML += `<div class="bg-white p-5 rounded-3xl shadow-sm border flex justify-between items-center"><div class="text-left"><p class="text-lg font-black italic">৳ ${p.amount}</p><p class="text-[9px] opacity-40 font-black uppercase">${p.type} | ${p.trxId}</p></div><span class="px-3 py-1 rounded-full text-[9px] font-black uppercase italic ${isOk ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}">${isOk ? 'Approved' : 'Pending'}</span></div>`;
                });
            });
        }

        function logout() { auth.signOut(); location.reload(); }
        initApp();
    </script>
</body>
</html>
