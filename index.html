<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSKF Admin Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background: #0f172a; color: #f1f5f9; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); border-radius: 2.5rem; transition: 0.3s; }
        .tab-active { background: #10b981; color: white; box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4); }
        .section-hide { display: none; }
    </style>
</head>
<body class="p-4 md:p-10">

    <header class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div class="flex items-center gap-4">
            <div class="bg-emerald-500 p-3 rounded-2xl shadow-2xl shadow-emerald-500/30"><i data-lucide="shield-check" class="text-white w-8 h-8"></i></div>
            <h1 class="text-3xl font-black italic tracking-tighter uppercase">BSKF <span class="text-emerald-500">Admin</span></h1>
        </div>
        <button onclick="window.location.href='index.html'" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-2xl font-bold text-sm shadow-xl">মেইন সাইট →</button>
    </header>

    <!-- Tabs Nav -->
    <div class="max-w-6xl mx-auto flex flex-wrap gap-2 mb-10 border-b border-slate-800 pb-6">
        <button id="tab-pending" onclick="switchTab('pending')" class="px-6 py-3 rounded-xl font-bold text-sm tab-active">পেন্ডিং যাচাই</button>
        <button id="tab-collection" onclick="switchTab('collection')" class="px-6 py-3 rounded-xl font-bold text-sm text-slate-400 hover:bg-slate-800">চলতি মাসের সংগ্রহ</button>
        <button id="tab-config" onclick="switchTab('config')" class="px-6 py-3 rounded-xl font-bold text-sm text-slate-400 hover:bg-slate-800">নম্বর ও খরচ আপডেট</button>
    </div>

    <main class="max-w-6xl mx-auto">
        
        <!-- Pending -->
        <section id="sec-pending">
            <h3 class="text-xl font-black italic text-emerald-400 mb-6 flex items-center gap-2 tracking-tight">ভেরিফিকেশনের জন্য নতুন রিকোয়েস্ট</h3>
            <div id="pendingList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </section>

        <!-- Current Month Collection -->
        <section id="sec-collection" class="section-hide space-y-6">
            <div class="flex justify-between items-center"><h3 class="text-xl font-black italic text-emerald-400">এই মাসের মোট কালেকশন</h3><span id="monthSum" class="bg-emerald-500/10 text-emerald-500 px-4 py-1 rounded-full font-bold text-xs border border-emerald-500/20 uppercase tracking-widest">মোট: ৳ ০</span></div>
            <div class="glass-card overflow-hidden"><table class="w-full text-left"><tbody id="collectionList" class="text-sm font-bold divide-y divide-slate-800"></tbody></table></div>
        </section>

        <!-- Config Center -->
        <section id="sec-config" class="section-hide grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="glass-card p-10 border-t-4 border-emerald-500">
                <h4 class="text-xl font-black mb-8 border-b border-slate-700 pb-4 italic tracking-tight">পেমেন্ট নম্বর পরিবর্তন</h4>
                <form id="adminNumForm" class="space-y-4">
                    <input type="text" id="bk" placeholder="বিকাশ নম্বর" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 font-black">
                    <input type="text" id="ng" placeholder="নগদ নম্বর" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 font-black">
                    <input type="text" id="rk" placeholder="রকেট নম্বর" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 font-black">
                    <button type="submit" class="w-full bg-emerald-600 py-4 rounded-2xl font-black shadow-xl hover:bg-emerald-500 transition">নম্বর সেভ করুন</button>
                </form>
            </div>
            <div class="glass-card p-10 border-t-4 border-red-500">
                <h4 class="text-xl font-black mb-8 border-b border-slate-700 pb-4 italic tracking-tight">নতুন খরচের হিসাব যোগ করুন</h4>
                <form id="adminExpForm" class="space-y-4">
                    <input type="text" id="eDesc" placeholder="খরচের বিবরণ (উদা: টিউবওয়েল মেরামত)" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 font-bold" required>
                    <input type="number" id="eAmt" placeholder="ব্যয়ের পরিমাণ" class="w-full bg-slate-800/50 p-4 rounded-2xl outline-none border border-slate-700 font-bold" required>
                    <button type="submit" class="w-full bg-red-600 py-4 rounded-2xl font-black shadow-xl">তহবিল থেকে ব্যয় করুন</button>
                </form>
            </div>
        </section>
    </main>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDeFrZUu2ZwWzFa7owaC0v6WO_zP2lEJ1Q",
          authDomain: "firstdevloping.firebaseapp.com",
          projectId: "firstdevloping",
          storageBucket: "firstdevloping.firebasestorage.app",
          messagingSenderId: "197486624624",
          appId: "1:197486624624:web:2b7b055dc3ecbad20399b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        lucide.createIcons();

        function switchTab(id) {
            ['pending', 'collection', 'config'].forEach(t => {
                document.getElementById('sec-' + t).classList.add('section-hide');
                document.getElementById('tab-' + t).classList.remove('tab-active', 'text-white');
                document.getElementById('tab-' + t).classList.add('text-slate-400');
            });
            document.getElementById('sec-' + id).classList.remove('section-hide');
            document.getElementById('tab-' + id).classList.add('tab-active', 'text-white');
            document.getElementById('tab-' + id).classList.remove('text-slate-400');
        }

        const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

        function loadAdmin() {
            // Pending Requests
            db.collection("payments").where("status", "==", "pending").onSnapshot(snap => {
                const list = document.getElementById('pendingList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    list.innerHTML += `<div class="glass-card p-6 border-l-4 border-emerald-500 shadow-2xl transition hover:scale-105 italic"><p class="text-[10px] font-black uppercase text-emerald-500 mb-2">${p.method}</p><h4 class="font-black text-lg">${p.name}</h4><p class="text-xs text-slate-500 mb-4">Trx: ${p.trxId} | From: ${p.from}</p><div class="text-3xl font-black text-emerald-400 mb-6 tracking-tighter">৳ ${p.amount}</div><button onclick="approve('${doc.id}', ${p.amount})" class="w-full bg-emerald-600 py-3 rounded-xl font-bold shadow-lg shadow-emerald-500/20">Approve</button></div>`;
                });
            });

            // Monthly Collection
            db.collection("payments").where("status", "==", "confirmed").onSnapshot(snap => {
                const list = document.getElementById('collectionList');
                list.innerHTML = "";
                let total = 0;
                let docs = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.timestamp?.toDate() >= startOfMonth) { docs.push(d); total += d.amount; }
                });
                docs.sort((a,b) => b.timestamp - a.timestamp).forEach(d => {
                    list.innerHTML += `<tr class="border-b border-slate-800 transition hover:bg-slate-800/40"><td class="py-5 px-6 font-bold text-slate-200 uppercase tracking-tighter">${d.name} <p class="text-[9px] text-slate-500 font-medium">ID: ${d.phone.slice(-4)}</p></td><td class="py-5 px-6 uppercase text-emerald-500 text-[10px] font-black italic">${d.method}</td><td class="py-5 px-6 opacity-30 text-[10px] uppercase font-mono">${d.trxId}</td><td class="py-5 px-6 font-black text-emerald-400">৳ ${d.amount}</td><td class="py-5 px-6 text-right opacity-30 text-[10px] uppercase font-black italic">${d.timestamp?.toDate().toLocaleDateString('bn-BD')}</td></tr>`;
                });
                document.getElementById('monthSum').innerText = "মোট সংগ্রহ: ৳ " + total.toLocaleString('bn-BD');
            });

            // Config Data
            db.collection("config").doc("payment_numbers").onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    document.getElementById('bk').value = d.bkash || '';
                    document.getElementById('ng').value = d.nagad || '';
                    document.getElementById('rk').value = d.rocket || '';
                }
            });
        }

        async function approve(pid, amt) {
            const batch = db.batch();
            batch.update(db.collection("payments").doc(pid), { status: 'confirmed' });
            batch.update(db.collection("stats").doc("summary"), { fund: firebase.firestore.FieldValue.increment(amt) });
            await batch.commit();
            alert("সফলভাবে এপ্রুভ হয়েছে!");
        }

        document.getElementById('adminNumForm').onsubmit = async (e) => {
            e.preventDefault();
            await db.collection("config").doc("payment_numbers").set({ bkash: document.getElementById('bk').value, nagad: document.getElementById('ng').value, rocket: document.getElementById('rk').value }, { merge: true });
            alert("নম্বর আপডেট হয়েছে!");
        };

        document.getElementById('adminExpForm').onsubmit = async (e) => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('eAmt').value);
            const batch = db.batch();
            batch.set(db.collection("expenses").doc(), { desc: document.getElementById('eDesc').value, amount: amt, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            batch.update(db.collection("stats").doc("summary"), { fund: firebase.firestore.FieldValue.increment(-amt), expenses: firebase.firestore.FieldValue.increment(amt) });
            await batch.commit();
            alert("ব্যয় আপডেট হয়েছে এবং মেইন ফান্ডের ব্যালেন্স কমেছে!");
            e.target.reset();
        };

        auth.onAuthStateChanged(async (user) => {
            if(user) {
                const doc = await db.collection("members").doc(user.email.split('@')[0]).get();
                if(doc.data().role === "admin") loadAdmin();
                else window.location.href="index.html";
            } else window.location.href="index.html";
        });
    </script>
</body>
</html>
